<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistik - Quiz Bahasa Jepang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'soft-pink': '#fdf2f8',
                        'soft-purple': '#f3e8ff',
                        'soft-blue': '#eff6ff',
                        'soft-green': '#f0fdf4',
                        'accent-pink': '#ec4899',
                        'accent-purple': '#8b5cf6',
                        'accent-blue': '#3b82f6',
                        'accent-green': '#10b981'
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-soft-green via-soft-blue to-soft-purple">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <a href="/" class="inline-flex items-center text-accent-purple hover:text-purple-600 mb-4 transition-colors">
                ‚Üê Kembali ke Beranda
            </a>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
                üìä Statistik Pembelajaran
            </h1>
            <p class="text-lg text-gray-600">
                Pantau perkembangan belajar bahasa Jepang Anda
            </p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl text-center">
                <div class="text-3xl mb-2">üéØ</div>
                <div class="text-2xl font-bold text-accent-purple mb-1" id="totalQuizzes">0</div>
                <div class="text-sm text-gray-600">Quiz Selesai</div>
            </div>
            
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl text-center">
                <div class="text-3xl mb-2">‚≠ê</div>
                <div class="text-2xl font-bold text-accent-green mb-1" id="averageScore">0%</div>
                <div class="text-sm text-gray-600">Rata-rata Skor</div>
            </div>
            
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl text-center">
                <div class="text-3xl mb-2">üèÜ</div>
                <div class="text-2xl font-bold text-accent-blue mb-1" id="bestScore">0%</div>
                <div class="text-sm text-gray-600">Skor Terbaik</div>
            </div>
            
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl text-center">
                <div class="text-3xl mb-2">‚è±Ô∏è</div>
                <div class="text-2xl font-bold text-accent-pink mb-1" id="totalTime">0m</div>
                <div class="text-sm text-gray-600">Total Waktu</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">üìà Perkembangan Skor</h3>
                <div class="relative h-64">
                    <canvas id="scoreChart"></canvas>
                </div>
            </div>
            
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">üéØ Tingkat Keberhasilan</h3>
                <div class="relative h-64">
                    <canvas id="accuracyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl">
            <h3 class="text-xl font-semibold text-gray-800 mb-6 text-center">üìö Riwayat Quiz</h3>
            <div id="quizHistory" class="space-y-4">
                </div>
        </div>
    </div>

    <script>
        class StatistikApp {
            constructor() {
                this.progressData = JSON.parse(localStorage.getItem('quizProgress') || '{}');
                this.init();
            }

            init() {
                this.updateSummaryCards();
                this.createScoreChart();
                this.createAccuracyChart();
                this.displayQuizHistory();
            }

            updateSummaryCards() {
                const quizzes = Object.values(this.progressData);
                const totalQuizzes = quizzes.length;
                const scores = quizzes.map(q => q.score);
                const totalTime = quizzes.reduce((sum, q) => sum + (q.timeSpent || 0), 0);
                
                const averageScore = totalQuizzes > 0 ? scores.reduce((sum, score) => sum + score, 0) / totalQuizzes : 0;
                const bestScore = totalQuizzes > 0 ? Math.max(...scores) : 0;
                
                document.getElementById('totalQuizzes').textContent = totalQuizzes;
                document.getElementById('averageScore').textContent = Math.round(averageScore) + '%';
                document.getElementById('bestScore').textContent = Math.round(bestScore) + '%';
                document.getElementById('totalTime').textContent = Math.round(totalTime / 60) + 'm';
            }

            createScoreChart() {
                const ctx = document.getElementById('scoreChart').getContext('2d');
                const quizzes = Object.entries(this.progressData).sort((a, b) => 
                    new Date(a[1].completedAt) - new Date(b[1].completedAt)
                );
                
                const labels = quizzes.map(([quizId, _]) => quizId.replace('kuis', '').replace('Pertemuan', 'P'));
                const scores = quizzes.map(([_, data]) => Math.round(data.score));
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Skor (%)',
                            data: scores,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#8b5cf6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                grid: { color: 'rgba(0, 0, 0, 0.1)' },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            x: {
                                grid: { color: 'rgba(0, 0, 0, 0.1)' }
                            }
                        },
                        elements: {
                            point: { hoverRadius: 8 }
                        }
                    }
                });
            }

            createAccuracyChart() {
                const ctx = document.getElementById('accuracyChart').getContext('2d');
                const quizzes = Object.values(this.progressData);
                
                if (quizzes.length === 0) {
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#6b7280';
                    ctx.textAlign = 'center';
                    ctx.fillText('Belum ada data quiz', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }
                
                const totalCorrect = quizzes.reduce((sum, q) => sum + q.correctAnswers, 0);
                const totalQuestions = quizzes.reduce((sum, q) => sum + q.totalQuestions, 0);
                const totalWrong = totalQuestions - totalCorrect;
                
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Benar', 'Salah'],
                        datasets: [{
                            data: [totalCorrect, totalWrong],
                            backgroundColor: ['#10b981', '#ef4444'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: { size: 14 }
                                }
                            }
                        },
                        cutout: '60%'
                    }
                });
            }

            displayQuizHistory() {
                const historyContainer = document.getElementById('quizHistory');
                const quizzes = Object.entries(this.progressData).sort((a, b) => 
                    new Date(b[1].completedAt) - new Date(a[1].completedAt)
                );
                
                if (quizzes.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">üìù</div>
                            <p>Belum ada riwayat quiz. Mulai quiz pertama Anda!</p>
                            <a href="/" class="inline-block mt-4 px-6 py-2 bg-accent-purple text-white rounded-xl hover:bg-purple-600 transition-colors">
                                Mulai Quiz
                            </a>
                        </div>
                    `;
                    return;
                }
                
                historyContainer.innerHTML = quizzes.map(([quizId, data]) => {
                    const date = new Date(data.completedAt).toLocaleDateString('id-ID', {
                        day: 'numeric', month: 'short', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                    
                    const quizName = quizId.replace('kuis', '').replace('Pertemuan', 'Pertemuan ');
                    const scoreColor = data.score >= 80 ? 'text-accent-green' : 
                                     data.score >= 60 ? 'text-accent-blue' : 'text-accent-pink';
                    
                    const timeInSeconds = data.timeSpent || 0;
                    const minutes = Math.floor(timeInSeconds / 60);
                    const seconds = timeInSeconds % 60;
                    const timeSpentFormatted = `${minutes}m ${seconds}s`;
                    
                    return `
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors">
                            <div class="flex-1 mb-3 md:mb-0">
                                <h4 class="font-semibold text-gray-800 mb-1">${quizName}</h4>
                                <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-600">
                                    <span>üìÖ ${date}</span>
                                    <span>‚è±Ô∏è ${timeSpentFormatted}</span>
                                    <span>‚úÖ ${data.correctAnswers}/${data.totalQuestions} benar</span>
                                </div>
                            </div>
                            <div class="flex-shrink-0 text-left md:text-right">
                                <div class="text-2xl font-bold ${scoreColor} mb-1">
                                    ${Math.round(data.score)}%
                                </div>
                                <button data-quiz-id="${quizId}" class="view-detail-btn text-sm text-accent-purple hover:text-purple-600 font-semibold transition-colors">
                                    Lihat Detail ‚Üí
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                // **PERBAIKAN:** Menggunakan addEventListener untuk menghindari masalah 'this'
                historyContainer.querySelectorAll('.view-detail-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const quizId = event.currentTarget.dataset.quizId;
                        this.showQuizDetail(quizId);
                    });
                });
            }

            showQuizDetail(quizId) {
                const data = this.progressData[quizId];
                if (!data || !data.answers) {
                    alert('Detail untuk kuis ini tidak tersedia.');
                    return;
                }

                // Hapus modal lama jika ada
                const oldModal = document.getElementById('quizDetailModal');
                if (oldModal) {
                    document.body.removeChild(oldModal);
                }

                const modal = document.createElement('div');
                modal.id = 'quizDetailModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
                
                const quizName = quizId.replace('kuis', '').replace('Pertemuan', 'Pertemuan ');

                modal.innerHTML = `
                    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] shadow-2xl flex flex-col">
                        <div class="p-6 border-b">
                           <h3 class="text-2xl font-bold text-gray-800 text-center">
                                Detail ${quizName}
                            </h3>
                        </div>
                        <div class="p-6 space-y-4 overflow-y-auto">
                            ${data.answers.map((answer, index) => `
                                <div class="p-4 rounded-xl ${answer.isCorrect ? 'bg-soft-green border-l-4 border-accent-green' : 'bg-soft-pink border-l-4 border-accent-pink'}">
                                    <p class="font-semibold text-gray-800 mb-2">Soal ${index + 1}:</p>
                                    <p class="text-gray-700 mb-3">${answer.question}</p>
                                    <div class="space-y-2 border-t pt-2 mt-2">
                                        <div class="text-sm">
                                            <span class="font-semibold">Jawaban Anda:</span> 
                                            <span class="${answer.isCorrect ? 'text-accent-green' : 'text-accent-pink'}">${answer.userAnswer}</span>
                                            ${answer.isCorrect ? '‚úÖ' : '‚ùå'}
                                        </div>
                                        ${!answer.isCorrect ? `
                                            <div class="text-sm">
                                                <span class="font-semibold">Jawaban Benar:</span> 
                                                <span class="text-accent-green">${answer.correctAnswer}</span> ‚úÖ
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-center p-4 border-t bg-gray-50 rounded-b-2xl">
                            <button id="closeDetailModalBtn" class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition-colors">
                                Tutup
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);

                // **PERBAIKAN:** Cara menutup modal yang lebih baik
                const closeModal = () => {
                    modal.classList.add('opacity-0');
                    setTimeout(() => {
                        if (document.body.contains(modal)) {
                            document.body.removeChild(modal);
                        }
                    }, 300);
                };

                document.getElementById('closeDetailModalBtn').addEventListener('click', closeModal);
                modal.addEventListener('click', (event) => {
                    // Tutup modal jika klik di luar area konten (pada backdrop)
                    if (event.target.id === 'quizDetailModal') {
                        closeModal();
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new StatistikApp();
        });
    </script>
</body>
</html>